<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="A wrapper function that analyzes a tile of loci in the genome to obtain correlated clusters."><title>Analyze genome tiles — analyze_tile • MotrpacRatTraining6mo</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Analyze genome tiles — analyze_tile"><meta property="og:description" content="A wrapper function that analyzes a tile of loci in the genome to obtain correlated clusters."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">MotrpacRatTraining6mo</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.5.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="../articles/MotrpacRatTraining6mo.html">Get started</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/MoTrPAC/MotrpacRatTraining6mo/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Analyze genome tiles</h1>
      <small class="dont-index">Source: <a href="https://github.com/MoTrPAC/MotrpacRatTraining6mo/blob/HEAD/R/rrbs_pipeline.R" class="external-link"><code>R/rrbs_pipeline.R</code></a></small>
      <div class="d-none name"><code>analyze_tile.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>A wrapper function that analyzes a tile of loci in the genome to obtain correlated clusters.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">analyze_tile</span><span class="op">(</span></span>
<span>  <span class="va">tile_name</span>,</span>
<span>  <span class="va">tile_l</span>,</span>
<span>  <span class="va">M</span>,</span>
<span>  min_cor <span class="op">=</span> <span class="fl">0.7</span>,</span>
<span>  inflations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2.5</span>, <span class="fl">2</span>, <span class="fl">1.5</span><span class="op">)</span>,</span>
<span>  plotcorr <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>tile_name</dt>
<dd><p>A character. The name of the current window for analysis.</p></dd>


<dt>tile_l</dt>
<dd><p>A named list. tile_name must be an item in the list. Each entry contains the M matrix row indices of the loci of the window.</p></dd>


<dt>M</dt>
<dd><p>A numeric matrix. Contains the "M" methylation values. Rows are loci, columns are samples.</p></dd>


<dt>min_cor</dt>
<dd><p>A number. The minimal correlation to be considered for connecting a pair of loci.</p></dd>


<dt>inflations</dt>
<dd><p>A numeric vector. Internal parameters of the MCL algorithm, see Details.</p></dd>


<dt>plotcorr</dt>
<dd><p>A logical. TRUE: plot the correlation matrix of the window (useful for analysis of specific windows).</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A character vector. Names are loci (M matrix rows), entries are the names of the loci clusters.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function implements clustering analysis of a specific window in the genome.
We observed that often adjacent loci in RRBS data may manifest low correlations. This
function can be used for identified a set of highly correlated loci within a window, which
can then be used to extract new genomic features for downstream analysis.
RRBS data have two columns per sample: "Un" (unmethylated) and "Me"(methylated). This function
takes the "M matrix" which contains the integrated values of these columns (see examples). This matrix
is used for computing the correlations of the loci, and then we use the Markov Clustering algorithm (MCL)
for identifying homogeneous clusters within a window.</p>
<p>MCL (Markov clustering) details from <a href="https://www.micans.org/mcl/intro.html" class="external-link">https://www.micans.org/mcl/intro.html</a>.
<strong>MCL:</strong> Expansion coincides with taking the power of a stochastic matrix
using the normal matrix product (i.e. matrix squaring).
Inflation corresponds with taking the Hadamard power of a matrix
(taking powers entrywise), followed by a scaling step, such that the resulting matrix is stochastic again,
i.e. the matrix elements (on each column) correspond to probability values.
<strong>Inflation parameter:</strong> strengthen intra-region connections and promote cluster homogeneity.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co"># Raw data by tissue are available as RData files in Google Cloud Storage with the following URLs:   </span></span></span>
<span class="r-in"><span><span class="co"># Brown adipose:</span></span></span>
<span class="r-in"><span><span class="co"># https://storage.googleapis.com/motrpac-rat-training-6mo-extdata/METHYL_BAT_RAW_DATA.rda</span></span></span>
<span class="r-in"><span><span class="co"># Heart: </span></span></span>
<span class="r-in"><span><span class="co"># https://storage.googleapis.com/motrpac-rat-training-6mo-extdata/METHYL_HEART_RAW_DATA.rda</span></span></span>
<span class="r-in"><span><span class="co"># Hippocampus: </span></span></span>
<span class="r-in"><span><span class="co"># https://storage.googleapis.com/motrpac-rat-training-6mo-extdata/METHYL_HIPPOC_RAW_DATA.rda</span></span></span>
<span class="r-in"><span><span class="co"># Kidney: </span></span></span>
<span class="r-in"><span><span class="co"># https://storage.googleapis.com/motrpac-rat-training-6mo-extdata/METHYL_KIDNEY_RAW_DATA.rda</span></span></span>
<span class="r-in"><span><span class="co"># Lung: </span></span></span>
<span class="r-in"><span><span class="co"># https://storage.googleapis.com/motrpac-rat-training-6mo-extdata/METHYL_LUNG_RAW_DATA.rda</span></span></span>
<span class="r-in"><span><span class="co"># Liver: </span></span></span>
<span class="r-in"><span><span class="co"># https://storage.googleapis.com/motrpac-rat-training-6mo-extdata/METHYL_LIVER_RAW_DATA.rda</span></span></span>
<span class="r-in"><span><span class="co"># Gastrocnemius: </span></span></span>
<span class="r-in"><span><span class="co"># https://storage.googleapis.com/motrpac-rat-training-6mo-extdata/METHYL_SKMGN_RAW_DATA.rda</span></span></span>
<span class="r-in"><span><span class="co"># White adipose: </span></span></span>
<span class="r-in"><span><span class="co"># https://storage.googleapis.com/motrpac-rat-training-6mo-extdata/METHYL_WATSC_RAW_DATA.rda</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># load_methyl_raw_data() can be used to download data for a tissue, e.g.,</span></span></span>
<span class="r-in"><span><span class="co"># download the gastrocnemius data and load the data object into this session:</span></span></span>
<span class="r-in"><span><span class="va">yall</span> <span class="op">=</span> <span class="fu"><a href="load_methyl_raw_data.html">load_methyl_raw_data</a></span><span class="op">(</span><span class="st">"SKM-GN"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># remove control samples</span></span></span>
<span class="r-in"><span><span class="va">is_sample</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^9"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">yall</span><span class="op">)</span>,perl<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">yall</span> <span class="op">=</span> <span class="va">yall</span><span class="op">[</span>,<span class="va">is_sample</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Filtering unassembled chromosomes</span></span></span>
<span class="r-in"><span><span class="va">keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">yall</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">Chr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">yall</span><span class="op">$</span><span class="va">genes</span><span class="op">$</span><span class="va">Chr</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">keep</span><span class="op">[</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"random"</span>,<span class="va">Chr</span><span class="op">)</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span><span class="va">keep</span><span class="op">[</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"chrUn"</span>,<span class="va">Chr</span><span class="op">)</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span><span class="co"># remove non-chr ones</span></span></span>
<span class="r-in"><span><span class="va">keep</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"chr"</span>,<span class="va">Chr</span><span class="op">)</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span><span class="co"># remove M chromosome (otherwise we get error when assigning annotation below)</span></span></span>
<span class="r-in"><span><span class="va">keep</span><span class="op">[</span><span class="va">Chr</span><span class="op">==</span><span class="st">"chrM"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span><span class="co"># keep.lib.sizes=FALSE causes the library sizes to be recomputed</span></span></span>
<span class="r-in"><span><span class="va">yall</span> <span class="op">&lt;-</span> <span class="va">yall</span><span class="op">[</span><span class="va">keep</span>,, keep.lib.sizes<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="co"># rat genome chromosomes:</span></span></span>
<span class="r-in"><span><span class="va">ChrNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"chr"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>,<span class="st">"X"</span>,<span class="st">"Y"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">yall</span><span class="op">$</span><span class="va">genes</span><span class="op">$</span><span class="va">Chr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">yall</span><span class="op">$</span><span class="va">genes</span><span class="op">$</span><span class="va">Chr</span>, levels<span class="op">=</span><span class="va">ChrNames</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">yall</span><span class="op">$</span><span class="va">genes</span><span class="op">$</span><span class="va">Chr</span>, <span class="va">yall</span><span class="op">$</span><span class="va">genes</span><span class="op">$</span><span class="va">Locus</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">yall</span> <span class="op">&lt;-</span> <span class="va">yall</span><span class="op">[</span><span class="va">o</span>,<span class="op">]</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Counts matrix dim before low counts filter:"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">yall</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Remove low count features</span></span></span>
<span class="r-in"><span><span class="co"># The analysis needs to be restricted to CpG sites that have enough coverage for the</span></span></span>
<span class="r-in"><span><span class="co"># methylation level to be measurable in a meaningful way at that site. </span></span></span>
<span class="r-in"><span><span class="co"># As a conservative rule of thumb, we require a site to have a total count</span></span></span>
<span class="r-in"><span><span class="co"># (both methylated and unmethylated) of at least 8 in every sample.</span></span></span>
<span class="r-in"><span><span class="va">Coverage</span> <span class="op">&lt;-</span> <span class="va">yall</span><span class="op">$</span><span class="va">counts</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"-Me"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">yall</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span> </span></span>
<span class="r-in"><span>     <span class="va">yall</span><span class="op">$</span><span class="va">counts</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"-Un"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">yall</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">min_count_coverage</span> <span class="op">=</span> <span class="fl">10</span></span></span>
<span class="r-in"><span><span class="va">min_per_samples</span> <span class="op">=</span> <span class="fl">1</span></span></span>
<span class="r-in"><span><span class="co"># see description of min_count_coverage and min_per_samples above</span></span></span>
<span class="r-in"><span><span class="va">keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Coverage</span> <span class="op">&gt;=</span> <span class="va">min_count_coverage</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">min_per_samples</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Coverage</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># filter the data</span></span></span>
<span class="r-in"><span><span class="va">yall</span> <span class="op">&lt;-</span> <span class="va">yall</span><span class="op">[</span><span class="va">keep</span>,, keep.lib.sizes<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Counts matrix dim after low counts filter:"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">yall</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># get locations, gene ids, etc</span></span></span>
<span class="r-in"><span><span class="va">TSS</span> <span class="op">&lt;-</span> <span class="fu">edgeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/edgeR/man/nearestTSS.html" class="external-link">nearestTSS</a></span><span class="op">(</span><span class="va">yall</span><span class="op">$</span><span class="va">genes</span><span class="op">$</span><span class="va">Chr</span>, <span class="va">yall</span><span class="op">$</span><span class="va">genes</span><span class="op">$</span><span class="va">Locus</span>, species<span class="op">=</span><span class="st">"Rn"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">yall</span><span class="op">$</span><span class="va">genes</span><span class="op">$</span><span class="va">EntrezID</span> <span class="op">&lt;-</span> <span class="va">TSS</span><span class="op">$</span><span class="va">gene_id</span></span></span>
<span class="r-in"><span><span class="va">yall</span><span class="op">$</span><span class="va">genes</span><span class="op">$</span><span class="va">Symbol</span> <span class="op">&lt;-</span> <span class="va">TSS</span><span class="op">$</span><span class="va">symbol</span></span></span>
<span class="r-in"><span><span class="va">yall</span><span class="op">$</span><span class="va">genes</span><span class="op">$</span><span class="va">Strand</span> <span class="op">&lt;-</span> <span class="va">TSS</span><span class="op">$</span><span class="va">strand</span></span></span>
<span class="r-in"><span><span class="va">yall</span><span class="op">$</span><span class="va">genes</span><span class="op">$</span><span class="va">Distance</span> <span class="op">&lt;-</span> <span class="va">TSS</span><span class="op">$</span><span class="va">distance</span></span></span>
<span class="r-in"><span><span class="va">yall</span><span class="op">$</span><span class="va">genes</span><span class="op">$</span><span class="va">Width</span> <span class="op">&lt;-</span> <span class="va">TSS</span><span class="op">$</span><span class="va">width</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Now we are ready to cluster the genome</span></span></span>
<span class="r-in"><span><span class="va">wsize</span> <span class="op">=</span> <span class="fl">500</span></span></span>
<span class="r-in"><span><span class="co"># step 1: define the genome-level tiles</span></span></span>
<span class="r-in"><span><span class="va">chrs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">yall</span><span class="op">$</span><span class="va">genes</span><span class="op">$</span><span class="va">Chr</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">pos</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">yall</span><span class="op">$</span><span class="va">genes</span><span class="op">$</span><span class="va">Locus</span><span class="op">/</span><span class="va">wsize</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">tiles</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">chrs</span>,<span class="va">pos</span>,sep<span class="op">=</span><span class="st">"-"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tiles</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">yall</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># step 2: add the M matrix for correlations</span></span></span>
<span class="r-in"><span><span class="va">Me</span> <span class="op">&lt;-</span> <span class="va">yall</span><span class="op">$</span><span class="va">counts</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"-Me"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">yall</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">Un</span> <span class="op">&lt;-</span> <span class="va">yall</span><span class="op">$</span><span class="va">counts</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"-Un"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">yall</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">Me</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">Un</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># step 3: analyze each tile</span></span></span>
<span class="r-in"><span><span class="va">tile_l</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>,<span class="va">tiles</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">tile_l</span> <span class="op">=</span> <span class="va">tile_l</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">tiles</span><span class="op">)</span><span class="op">]</span> <span class="co"># keep the genome order</span></span></span>
<span class="r-in"><span><span class="co"># parallel comp</span></span></span>
<span class="r-in"><span><span class="kw">if</span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st">"parallel"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">tile_clusters</span> <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">tiles</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="kw">for</span><span class="op">(</span><span class="va">chr</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">chrs</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">chr</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="va">curr_chr_inds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">chr</span>,<span class="st">"-"</span><span class="op">)</span>,<span class="va">tiles</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="va">chr_tiles</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">tiles</span><span class="op">[</span><span class="va">curr_chr_inds</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="va">chr_tile_l</span> <span class="op">=</span> <span class="va">tile_l</span><span class="op">[</span><span class="va">chr_tiles</span><span class="op">]</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="va">chr_tile_clusters</span> <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span><span class="va">chr_tiles</span>,</span></span>
<span class="r-in"><span>                                             <span class="va">analyze_tile</span>,</span></span>
<span class="r-in"><span>                                             tile_l <span class="op">=</span> <span class="va">chr_tile_l</span>,</span></span>
<span class="r-in"><span>                                             M <span class="op">=</span> <span class="va">M</span>, </span></span>
<span class="r-in"><span>                                             mc.cores <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></span>
<span class="r-in"><span>      <span class="va">chr_tile_clusters</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">chr_tile_clusters</span><span class="op">)</span></span></span>
<span class="r-in"><span>      <span class="va">tile_clusters</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">chr_tile_clusters</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="va">chr_tile_clusters</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="va">yall</span> <span class="op">=</span> <span class="fu"><a href="merge_sites_by_clusters.html">merge_sites_by_clusters</a></span><span class="op">(</span><span class="va">yall</span>,<span class="va">tile_clusters</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Data normalization</span></span></span>
<span class="r-in"><span><span class="co"># A key difference between BS-seq and other sequencing data is that the pair of libraries </span></span></span>
<span class="r-in"><span><span class="co"># holding the methylated and unmethylated reads for a particular sample are treated as a unit.</span></span></span>
<span class="r-in"><span><span class="co"># To ensure that the methylated and unmethylated reads for the same sample are treated on the</span></span></span>
<span class="r-in"><span><span class="co"># same scale, we need to set the library sizes to be equal for each pair of libraries. </span></span></span>
<span class="r-in"><span><span class="co"># We set the library sizes for each sample to be the average of the total read counts for </span></span></span>
<span class="r-in"><span><span class="co"># the methylated and unmethylated libraries.</span></span></span>
<span class="r-in"><span><span class="co"># Other normalization methods developed for RNA-seq data, </span></span></span>
<span class="r-in"><span><span class="co"># such as TMM, are not required for BS-seq data.</span></span></span>
<span class="r-in"><span><span class="va">TotalLibSize</span> <span class="op">&lt;-</span> <span class="va">yall</span><span class="op">$</span><span class="va">samples</span><span class="op">$</span><span class="va">lib.size</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"-Me"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">yall</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span> </span></span>
<span class="r-in"><span>  <span class="va">yall</span><span class="op">$</span><span class="va">samples</span><span class="op">$</span><span class="va">lib.size</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"-Un"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">yall</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">yall</span><span class="op">$</span><span class="va">samples</span><span class="op">$</span><span class="va">lib.size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">TotalLibSize</span>, each<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Nicole Gay, David Amar, Pierre Jean Beltran, MoTrPAC Study Group, NIH Common Fund, National Institute of Diabetes and Digestive and Kidney Diseases (NIDDK), National Institute of Arthritis and Musculoskeletal Diseases (NIAMS), National Institute on Aging (NIA), National Institute of Biomedical Imaging and Bioengineering.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

